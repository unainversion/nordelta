<!DOCTYPE html>
<html lang="es">
  <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Nordelta</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,
		<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 60'>
		<style> .cs { stroke: rgb(9, 9, 9); stroke-width: 2; } </style>
		<style> .bl { fill: rgb(255, 255, 255); } </style>
		<style> .ng { fill: rgb(0, 0, 0); } </style>
		<circle cx='30' cy='30' r='30' class='cs ng'/>
		<circle cx='30' cy='30' r='10' class='cs bl'/>
		<circle cx='10' cy='30' r='10' class='cs bl'/>
		<circle cx='50' cy='30' r='10' class='cs bl'/>
		<circle cx='40' cy='12.67' r='10' class='cs bl'/>
		<circle cx='20' cy='12.67' r='10' class='cs bl'/>
		<circle cx='40' cy='47.32' r='10' class='cs bl'/>
		<circle cx='20' cy='47.32' r='10' class='cs bl'/> 
		</svg>">

		<script>
			const rmt = document.createElement("script");
			rmt.src = "https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.10.0/p5.min.js";
			rmt.onerror = function() {
				console.log("ERROR en carga remota de p5.min.js");
				console.log("SOLUCION: intentando carga local de p5.min.js");
				const lcl = document.createElement("script");
				lcl.onerror = () => console.log("ERROR en carga local de p5.min.js");
				lcl.src = "p5.min.js";
				document.head.appendChild(lcl);
			};
			document.head.appendChild(rmt);
		</script>

		<style>
			html, body {
				margin: 0;
				padding: 0;
				overflow: hidden;
				box-sizing: border-box;
				background-color: rgb(255, 255, 255);
  			touch-action: manipulation;
				user-select: none;
			}

			#contenedor-canvas {
				width: 100vw;
				width: 100svw;
				height: 100vh;
				height: 100svh;

				display: flex;
  			justify-content: center;
  			align-items: center;

				background-color: rgb(255, 255, 255);
			}
		 </style>
  </head>

  <body>
		 <script>
			setInterval(() => console.log(window.visualViewport.height), 1);
		 </script>
    <main id="contenedor-canvas">
    </main>
    <script>

/////////////////////////////////////////////

let imgFondo, imgDcto;

let inicio = true;

let touch = false;
let entrada_x, entrada_y;

let scroll = 0;
let offset = 0;
let offsetAcc = 0;

/////////////////////////

function preload() {
	const url = window.location;
	const r_url = `${url.origin}${url.pathname.split('/').slice(0, 2).join('/')}`;

	imgFondo = loadImage(r_url + "/fondo.png", null, () => {
		console.log("ERROR en carga remota de fondo.png");
		console.log("SOLUCION: intentando carga local de fondo.png");
		imgFondo = loadImage("fondo.png", null, () => {
			console.log("ERROR en carga local de fondo.png ")
		});
	});

	imgDscto = loadImage(r_url + "/dscto.png", null, () => {
		console.log("ERROR en carga remota de dscto.png");
		console.log("SOLUCION: intentando carga local de dscto.png");
		imgDscto = loadImage("dscto.png", null, () => {
			console.log("ERROR en carga local de dscto.png ")
		});
	});
}

function setup() {

	createCanvas(540, 960).parent("contenedor-canvas"); // (temporal)
	adaptarCanvas(5); // resize y responsive (medidas definitivas)
	if (height > 980) offsetAcc = 980 - height;

	imgFondo.width = width;

	background(255);
	textAlign(CENTER, CENTER);
	textSize(14);
	noStroke();

	// evento cambio medidas
	const visual = window.visualViewport ? true : false;
	if (visual) window.visualViewport.addEventListener('resize', () => adaptarCanvas(1));
	else window.addEventListener('resize', () => adaptarCanvas(2));
	
	// evento cambio fullscreen
	document.addEventListener("fullscreenchange", () => adaptarCanvas(3));
	document.addEventListener("webkitfullscreenchange", () => adaptarCanvas(4));
}

/////////////////////////

function draw() {
	
	// captura touch
	if (touch) offset = entrada_y - mouseY;
	else offset = 0;
	scroll = offset + offsetAcc;
	if (scroll < -500) {
		scroll = -500;
		offsetAcc = -500;
	}

	// dibujos
	if (inicio) dibujoInicio();
	else dibujoSpam();
}

/////////////////////////

function dibujoInicio() {
	
	// fondo principal
	background(255);

	image(imgFondo, 0, -scroll);
	
	push();
	tint(255, (sin(millis() * 0.004) + 1) * 127);
	image(imgDscto, 270, 764 - scroll);
	pop();
	
	if (scroll < 600) return;
	image(imgFondo, 0, imgFondo.height - scroll);
}

/////////////////////////

function dibujoSpam() {
	background(0, 255, 255, 10);

	const rx = random(width);
	const ry = random(height);
	const rr = random(-PI, PI);
	const rs = random(0.5, 5);

	push();
	translate(rx, ry);
	rotate(rr);
	scale(rs);

	textSize(20);
	fill(255, 0, 0);
	text("SAPM!", 0, 0)
	pop();
}

/////////////////////////

let evitar_s = false;
function touchStarted() {

	// evitar doble accion
	if (evitar_s) return;
  evitar_s = true;
  setTimeout(function() {
    evitar_s = false;
  }, 200);

	// evitar fuera de pantalla
	if (
		mouseX < 0 ||
		mouseX > width ||
		mouseY < 0 ||
		mouseY > height
	) return;

	// guardar inicio touch
	entrada_x = mouseX;
	entrada_y = mouseY;

	// iniciar touch
	touch = true;
	offset = 0;
}

/////////////////////////

let touched = false;
let evitar_e = false;
function touchEnded() {

	// evitar doble accion
	if (evitar_e) return;
  evitar_e = true;
  setTimeout(function() {
    evitar_e = false;
  }, 200);

	// teminar touch generico
	offsetAcc += offset;
	touch = false;

	// evitar fuera de pantalla
	if (
		mouseX < 0 ||
		mouseX > width ||
		mouseY < 0 ||
		mouseY > height
	) return;

	// PRIMER TOUCH VALIDADO
	if (!touched) {
		touched = true;
		return; // <-- salida temprana
	}

	// SEGUNDO TOUCH VALIDADO
	inicio = false;

	// solicitud de fullscreen
	if (document.documentElement.requestFullscreen) { // CHR (estandar)
		document.documentElement.requestFullscreen();
	}
	else if (document.documentElement.webkitRequestFullscreen) { // SFI
		document.documentElement.webkitRequestFullscreen();
	}
	else if (document.documentElement.mozRequestFullScreen) { // FFX
		document.documentElement.mozRequestFullScreen();
	}
}

/////////////////////////

function adaptarCanvas(manual = 0) {
	
	// viewport
	const visual = window.visualViewport ? true : false;
	const vpt_w = visual ? window.visualViewport.width : window.innerWidth;
	const vpt_h = visual ? window.visualViewport.height : window.innerHeight;
	
	// canvas
	const cnv_w = 540; // mitad de 1080
	const cnv_h = cnv_w * vpt_h / vpt_w;
	resizeCanvas(cnv_w, cnv_h);
	
	// canvas responsive
	const cnvs = document.getElementById("defaultCanvas0");

	console.log(':::::::::::::::::::::::::::::::::');
	console.log("adaptarCanvas MANUAL: " + manual);
	console.log("offsetAcc: " + offsetAcc);
	console.log("visual: " + visual);
	console.log("vpt_w: " + vpt_w);
	console.log("vpt_h: " + vpt_h);
	console.log("cnv_w: " + cnv_w);
	console.log("cnv_h: " + cnv_h);
	console.log("cnvs:");
	console.dir(cnvs);
	console.log('"""""""""""""""""""""""""""""""""');

  if (windowWidth * height < windowHeight * width) {
		cnvs.style.width = vpt_w + "px";
    cnvs.style.height = (vpt_w / cnv_w) * cnv_h + "px";
  }
  else {
    cnvs.style.height = vpt_h + "px";
    cnvs.style.width = (vpt_h / cnv_h) * cnv_w + "px";
  }
}

/////////////////////////

// eventos default touch
window.addEventListener('load', () => {

	// prevenir gestos touch multiple
	document.addEventListener('touchstart', (e) => {
		if (e.touches.length > 1) e.preventDefault(); 
	}, { passive: false });

	// prevenir "volver" o "cargar de nuevo"
	document.addEventListener('touchmove', (e) => {
		e.preventDefault();
	}, { passive: false });

	// prevenir zoom
	document.addEventListener('gesturestart', (e) => {
		e.preventDefault();
	}, { passive: false });
});

/////////////////////////////////////////////

		</script>
  </body>
</html>
